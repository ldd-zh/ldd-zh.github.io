# 内核中的调试支持

在第2章中，我们建议你构建并安装自己的内核，而不是使用发行版提供的标准内核。运行自定义内核的一个主要原因是内核开发者在内核中内置了多种调试功能。这些功能可能会产生额外的输出并降低性能，因此发行版的生产内核通常不会启用这些功能。然而，作为内核开发者，你有不同的优先级，并且会乐意接受额外的内核调试支持带来的（最小）开销。

这里，我们列出了用于开发的内核应启用的配置选项。除非另有说明，所有这些选项都可以在内核配置工具的“kernel hacking”菜单中找到。请注意，并非所有架构都支持这些选项。

- **CONFIG_DEBUG_KERNEL**：此选项仅使其他调试选项可用；它应该被启用，但本身并不启用任何功能。
- **CONFIG_DEBUG_SLAB**：此关键选项在内核内存分配函数中启用多种检查；启用这些检查后，可以检测到多种内存溢出和未初始化错误。
- **CONFIG_DEBUG_PAGEALLOC**：释放的完整页面将从内核地址空间中移除。此选项可能会显著降低性能，但它可以快速指出某些内存损坏错误。
- **CONFIG_DEBUG_SPINLOCK**：启用此选项后，内核会捕获未初始化的自旋锁操作以及其他错误（例如多次解锁）。
- **CONFIG_DEBUG_SPINLOCK_SLEEP**：此选项启用对持有自旋锁时尝试睡眠的检查。
- **CONFIG_INIT_DEBUG**：标记为`__init`（或`__initdata`）的项在系统初始化或模块加载后被丢弃。此选项启用对初始化完成后访问初始化内存的代码的检查。
- **CONFIG_DEBUG_INFO**：此选项使内核构建时包含完整的调试信息。如果你计划使用`gdb`调试内核，则需要此信息。
- **CONFIG_MAGIC_SYSRQ**：启用“魔术SysRq”键。我们将在本章后面的“系统挂起”部分讨论此键。
- **CONFIG_DEBUG_STACKOVERFLOW** 和 **CONFIG_DEBUG_STACK_USAGE**：这些选项可以帮助追踪内核栈溢出问题。
- **CONFIG_KALLSYMS**：此选项（位于“General setup/Standard features”下）使内核符号信息构建到内核中；默认情况下启用。符号信息用于调试上下文；没有它，`oops`列表只能以十六进制形式给出内核回溯，这不太有用。
