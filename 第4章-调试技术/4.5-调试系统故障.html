<!DOCTYPE html> <html><head>
		<title>4.5 调试系统故障</title>
		<base href="../">
		<meta id="root-path" root-path="../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="ldd_zh - 4.5 调试系统故障">
		<meta property="og:title" content="4.5 调试系统故障">
		<meta property="og:description" content="ldd_zh - 4.5 调试系统故障">
		<meta property="og:type" content="website">
		<meta property="og:url" content="第4章-调试技术/4.5-调试系统故障.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="ldd_zh">
		<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager native-scrollbars theme-light show-inline-title show-ribbon"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="4.5 调试系统故障">4.5 调试系统故障</h1><div class="el-p"><p dir="auto">即使你使用了所有的监控和调试技术，有时驱动程序中仍然存在错误，系统在执行驱动程序时会崩溃。当这种情况发生时，重要的是能够收集尽可能多的信息来解决问题。</p></div><div class="el-p"><p dir="auto">请注意，“故障”并不意味着“恐慌”。Linux 代码足够健壮，能够优雅地响应大多数错误：故障通常会导致当前进程被销毁，而系统继续运行。系统可能会恐慌，如果故障发生在进程上下文之外，或者系统的某些关键部分受到损害，它可能会恐慌。但当问题是由于驱动程序错误引起的时，通常只会导致使用驱动程序的进程突然死亡。当进程被销毁时，唯一不可恢复的损害是分配给进程上下文的一些内存丢失；例如，驱动程序通过 <code>kmalloc</code> 分配的动态列表可能会丢失。然而，由于内核在进程死亡时为任何打开的设备调用 <code>close</code> 操作，你的驱动程序可以释放 <code>open</code> 方法分配的内容。</p></div><div class="el-p"><p dir="auto">即使 <code>oops</code> 通常不会导致整个系统崩溃，你可能会发现自己在 <code>oops</code> 后需要重新启动。一个有问题的驱动程序可能会使硬件处于不可用状态，使内核资源处于不一致状态，或者在最坏的情况下，随机损坏内核内存。通常，你可以简单地卸载有问题的驱动程序，并在 <code>oops</code> 后重试。然而，如果你看到任何表明整个系统不正常的迹象，通常最好立即重新启动。</p></div><div class="el-p"><p dir="auto">我们已经说过，当内核代码行为不当时，控制台上会打印一条信息丰富的消息。下一节将解释如何解码和使用这些消息。即使对新手来说，它们看起来相当晦涩，处理器转储充满了有趣的信息，通常足以在不进行额外测试的情况下精确定位程序错误。</p></div><div class="el-h2 heading-wrapper"><h2 data-heading="`Oops` 消息" dir="auto" class="heading" id="`Oops`_消息"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><code>Oops</code> 消息</h2><div class="heading-children"><div class="el-p"><p dir="auto">大多数错误表现为 <code>NULL</code> 指针解引用或使用其他不正确的指针值。此类错误的通常结果是 <code>oops</code> 消息。</p></div><div class="el-p"><p dir="auto">处理器使用的几乎所有地址都是虚拟地址，并通过复杂的页表结构映射到物理地址（例外情况是与内存管理子系统本身一起使用的物理地址）。当解引用无效指针时，分页机制无法将指针映射到物理地址，处理器向操作系统发出页面错误信号。如果地址无效，内核无法“调入”缺失的地址；如果这种情况发生在处理器处于超级用户模式时，它（通常）会生成一个 <code>oops</code>。</p></div><div class="el-p"><p dir="auto"><code>oops</code> 显示故障时的处理器状态，包括 CPU 寄存器的内容和其他看似难以理解的信息。该消息由故障处理程序（<code>arch/*/kernel/traps.c</code>）中的 <code>printk</code> 语句生成，并按照前面“printk”部分中描述的方式分派。</p></div><div class="el-p"><p dir="auto">让我们看一个这样的消息。以下是在运行 2.6 版本内核的 PC 上解引用 <code>NULL</code> 指针的结果。这里最相关的信息是指令指针（EIP），即错误指令的地址。</p></div><div class="el-pre"><pre class="language-bash" tabindex="0"><code data-line="0" class="language-bash is-loaded">Unable to handle kernel NULL pointer dereference at virtual address 00000000
printing eip:
d083a064
Oops: 0002 <span class="token punctuation">[</span><span class="token comment">#1]</span>
SMP
CPU: <span class="token number">0</span>
EIP: 0060:<span class="token punctuation">[</span><span class="token operator">&lt;</span>d083a06<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span><span class="token punctuation">]</span> Not tainted
EFLAGS: 00010246 <span class="token punctuation">(</span><span class="token number">2.6</span>.6<span class="token punctuation">)</span>
EIP is at faulty_write+0x4/0x10 <span class="token punctuation">[</span>faulty<span class="token punctuation">]</span>
eax: 00000000 ebx: 00000000 ecx: 00000000 edx: 00000000
esi: cf802460 edi: cf802480 ebp: 00000005 esp: c31c5f74
ds: 007b es: 007b ss: 0088
Process <span class="token function">bash</span> <span class="token punctuation">(</span>pid: <span class="token number">2086</span>, <span class="token assign-left variable">threadinfo</span><span class="token operator">=</span>c31c4000 <span class="token assign-left variable">task</span><span class="token operator">=</span>cfaa6c0<span class="token punctuation">)</span>
Stack: c0150558 cf802460 080e9408 00000005 cf802480 00000000 cf802460 cf802460 ffffff7 080e9408 c31c4000 c0150682 cf802460 080e9408 00000005 cf802480 00000000 00000001 00000005 c0103ff6f 00000001 080e9408 00000005 00000005
Call Trace:
<span class="token punctuation">[</span>c0150558<span class="token punctuation">]</span> vfs_write+0x18/0x130
<span class="token punctuation">[</span>c0150682<span class="token punctuation">]</span> sys_write+0x42/0x70
<span class="token punctuation">[</span>c0103ff6f<span class="token punctuation">]</span> syscall_call+0x7/0xb
Code: <span class="token number">89</span> <span class="token number">15</span> 00 00 00 00 c3 <span class="token number">90</span> <span class="token number">84</span> <span class="token number">74</span> <span class="token number">26</span> 00 <span class="token number">83</span> ec 0c b8 00 a6 <span class="token number">83</span> d0
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">此消息是由写入 <code>faulty</code> 模块拥有的设备生成的，该模块是专门为演示故障而构建的。<code>faulty.c</code> 的 <code>write</code> 方法的实现非常简单：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token class-name">ssize_t</span> <span class="token function">faulty_write</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* 通过解引用 NULL 指针制造一个简单的故障 */</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">正如你所看到的，我们在这里所做的就是解引用一个 <code>NULL</code> 指针。由于 0 从来不是有效的指针值，因此会发生故障，内核将其转换为前面显示的 <code>oops</code> 消息。然后调用进程被杀死。</p></div><div class="el-p"><p dir="auto"><code>faulty</code> 模块在其 <code>read</code> 实现中有一个不同的故障条件：</p></div><div class="el-pre"><pre class="language-c" tabindex="0"><code data-line="0" class="language-c is-loaded"><span class="token class-name">ssize_t</span> <span class="token function">faulty_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span>
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">char</span> stack_buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/* 让我们尝试一个缓冲区溢出 */</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>stack_buf<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span>
        count <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">/* 复制 4 个字节给用户 */</span>
    ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> stack_buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">此方法将一个字符串复制到局部变量中；不幸的是，字符串比目标数组长。当函数返回时，生成的缓冲区溢出会导致 <code>oops</code>。由于返回指令将指令指针带到无处之地，这种故障更难追踪，你可能会得到如下内容：</p></div><div class="el-pre"><pre class="language-bash" tabindex="0"><code data-line="0" class="language-bash is-loaded">EIP: 0010:<span class="token punctuation">[</span><span class="token operator">&lt;</span>0000000<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">]</span>
Unable to handle kernel paging request at virtual address ffffffff
printing eip:
ffffffff
Oops: 0000 <span class="token punctuation">[</span><span class="token comment">#5]</span>
SMP
CPU: <span class="token number">0</span>
EIP: 0060:<span class="token punctuation">[</span><span class="token operator">&lt;</span>ffffffff<span class="token operator">&gt;</span><span class="token punctuation">]</span> Not tainted
EFLAGS: 00010296 <span class="token punctuation">(</span><span class="token number">2.6</span>.6<span class="token punctuation">)</span>
EIP is at 0xffffffff
eax: 0000000 cbx: ffffffff ecx: 0000000 edx: bfffdafc
esi: cf434f00 edi: ffffffff ebp: 00002000 esp: cz7ffff78
ds: 0070 es: 0070 ss: 0068
Process <span class="token function">head</span> <span class="token punctuation">(</span>pid: <span class="token number">3331</span>, <span class="token assign-left variable">threadinfo</span><span class="token operator">=</span>c27fe000 <span class="token assign-left variable">task</span><span class="token operator">=</span>e32d51c0<span class="token punctuation">)</span>
Stack: ffffffff bfffdaf0 00002000 cf434f20 00000001 00000286 cf434f00 ffffffff7
    bfffdaf0 cz7fe000 cd50612 cf434f00 bfffdaf0 00002000 cf434f20 00000000
    00000003 00002000 cd103f8f 00000003 bfffdaf0 00002000 00002000 bfffdaf0
Call Trace:
<span class="token punctuation">[</span>ccd15061<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token punctuation">]</span> sys_read40442/0x70
<span class="token punctuation">[</span>
**

<span class="token comment">### `Oops` 消息（续）</span>

```bash
<span class="token punctuation">[</span>ccd103f8f<span class="token operator">&gt;</span><span class="token punctuation">]</span> syscall_call+0x7/0xb
Code: Bad EIP value.
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">在这种情况下，我们只看到部分调用栈（<code>vfs_read</code> 和 <code>faulty_read</code> 缺失），内核抱怨“错误的 EIP 值”。这个抱怨以及开头列出的错误地址（<code>ffffffff</code>）都是内核栈已损坏的提示。</p></div><div class="el-p"><p dir="auto">通常，当你面对 <code>oops</code> 时，首先要看的是问题发生的位置，这通常与调用栈分开列出。在上面显示的第一个 <code>oops</code> 中，相关的行是：</p></div><div class="el-pre"><pre class="language-bash" tabindex="0"><code data-line="0" class="language-bash is-loaded">EIP is at faulty_write+0x4/0x10 <span class="token punctuation">[</span>faulty<span class="token punctuation">]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">这里我们看到我们在 <code>faulty_write</code> 函数中，该函数位于 <code>faulty</code> 模块中（方括号中列出）。十六进制数字表示指令指针位于函数中的第 4 个字节，该函数似乎是 10（十六进制）字节长。通常，这足以找出问题所在。</p></div><div class="el-p"><p dir="auto">如果你需要更多信息，调用栈会显示你是如何到达问题发生的地方的。栈本身以十六进制形式打印；通过一些工作，你通常可以从栈列表中确定局部变量和函数参数的值。有经验的内核开发者可以从这里的模式识别中受益；例如，如果我们查看 <code>faulty_read</code> 的 <code>oops</code> 中的栈列表：</p></div><div class="el-pre"><pre class="language-bash" tabindex="0"><code data-line="0" class="language-bash is-loaded">Stack:
ffffffff bfffda70 00002000 cfa347a0 00000001 00000286 cfa347a0 ffffffff7
bfffda70 c27fe000 c0150612 cfa347a0 bfffda70 00002000 cfa347a0 00000000
00000003 00002000 c010378f 00000003 bfffda70 00002000 00002000 bfffda70
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">栈顶的 <code>ffffffff</code> 是我们破坏的字符串的一部分。在 x86 架构上，默认情况下，用户空间栈从 <code>0xc0000000</code> 以下开始；因此，重复的值 <code>0xbfffda70</code> 可能是用户空间栈地址；实际上，它是传递给 <code>read</code> 系统调用的缓冲区的地址，每次传递到内核调用链时都会复制它。在 x86 上（再次，默认情况下），内核空间从 <code>0xc0000000</code> 开始，因此高于该值的值几乎肯定是内核空间地址，依此类推。</p></div><div class="el-p"><p dir="auto">最后，在查看 <code>oops</code> 列表时，始终要注意本章开头讨论的“slab poisoning”值。因此，例如，如果你得到一个内核 <code>oops</code>，其中错误地址是 <code>0xa5a5a5a5</code>，你几乎肯定是在某个地方忘记初始化动态内存。</p></div><div class="el-p"><p dir="auto">请注意，只有在启用 <code>CONFIG_KALLSYMS</code> 选项构建内核时，你才会看到符号调用栈（如上所示）。否则，你会看到一个裸的十六进制列表，这在解码之前不太有用。</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="系统挂起" dir="auto" class="heading" id="系统挂起"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>系统挂起</h2><div class="heading-children"><div class="el-p"><p dir="auto">尽管内核代码中的大多数错误最终都会导致 <code>oops</code> 消息，但有时它们可能会完全挂起系统。如果系统挂起，则不会打印任何消息。例如，如果代码进入无限循环，内核会停止调度，系统不会响应任何操作，包括 <code>Ctrl-Alt-Del</code> 组合键。你有两种选择来处理系统挂起——要么事先预防，要么事后调试。</p></div><div class="el-p"><p dir="auto">你可以通过在关键点插入 <code>schedule</code> 调用来防止无限循环。<code>schedule</code> 调用（正如你可能猜到的）调用调度程序，因此允许其他进程从当前进程窃取 CPU 时间。如果一个进程由于你的驱动程序中的错误而在内核空间中循环，<code>schedule</code> 调用使你能够在跟踪正在发生的事情后杀死该进程。</p></div><div class="el-p"><p dir="auto">你应该意识到，当然，任何对 <code>schedule</code> 的调用都可能创建对你的驱动程序的额外重入调用，因为它允许其他进程运行。这种重入通常不应该是一个问题，假设你在驱动程序中使用了适当的锁定。但是，请确保不要在驱动程序持有自旋锁的任何时候调用 <code>schedule</code>。</p></div><div class="el-p"><p dir="auto">如果你的驱动程序真的挂起了系统，并且你不知道在哪里插入 <code>schedule</code> 调用，最好的方法可能是添加一些打印消息并将它们写入控制台（如果需要，可以通过更改 <code>console_loglevel</code> 值）。</p></div><div class="el-p"><p dir="auto">有时系统可能看起来挂起，但实际上并没有。例如，如果键盘以某种奇怪的方式锁定，可能会发生这种情况。这些假挂起可以通过查看你为此目的保持运行的程序的输出来检测。显示器上的时钟或系统负载表是一个很好的状态监视器；只要它继续更新，调度程序就在工作。</p></div><div class="el-p"><p dir="auto">许多锁定的一个不可或缺的工具是“魔法 SysRq 键”，它在大多数架构上都可用。魔法 SysRq 是通过 PC 键盘上的 <code>Alt</code> 和 <code>SysRq</code> 键的组合调用的，或者在其他平台上使用其他特殊键（详见 <code>Documentation/sysrq.txt</code>），并且在串行控制台上也可用。第三个键与这两个键一起按下，执行以下有用的操作之一：</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">
<p><strong>r</strong><br>
关闭键盘原始模式；在崩溃的应用程序（如 X 服务器）可能使键盘处于奇怪状态的情况下很有用。</p>
</li>
<li data-line="3" dir="auto">
<p><strong>k</strong><br>
调用“安全注意键”（SAK）功能。SAK 杀死当前控制台上运行的所有进程，给你一个干净的终端。</p>
</li>
<li data-line="6" dir="auto">
<p><strong>s</strong><br>
执行所有磁盘的紧急同步。</p>
</li>
<li data-line="9" dir="auto">
<p><strong>u</strong><br>
卸载。尝试以只读模式重新挂载所有磁盘。此操作通常在 <code>s</code> 之后立即调用，可以在系统严重故障时节省大量文件系统检查时间。</p>
</li>
<li data-line="12" dir="auto">
<p><strong>b</strong><br>
启动。立即重新启动系统。确保先同步并重新挂载磁盘。</p>
</li>
<li data-line="15" dir="auto">
<p><strong>p</strong><br>
打印处理器寄存器信息。</p>
</li>
<li data-line="18" dir="auto">
<p><strong>t</strong><br>
打印当前任务列表。</p>
</li>
<li data-line="21" dir="auto">
<p><strong>m</strong><br>
打印内存信息。</p>
</li>
</ul></div><div class="el-p"><p dir="auto">其他魔法 SysRq 功能也存在；有关完整列表，请参阅内核源代码的 <code>Documentation</code> 目录中的 <code>sysrq.txt</code>。请注意，魔法 SysRq 必须在内核配置中显式启用，大多数发行版出于明显的安全原因不会启用它。然而，对于用于开发驱动程序的系统，启用魔法 SysRq 是值得的。魔法 SysRq 可以在运行时通过以下命令禁用：</p></div><div class="el-pre"><pre class="language-bash" tabindex="0"><code data-line="0" class="language-bash is-loaded"><span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">&gt;</span> /proc/sys/kernel/sysrq
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">如果非特权用户可以访问你的系统键盘，你应该考虑禁用它，以防止意外或故意的损坏。一些以前的内核版本默认禁用 <code>sysrq</code>，因此你需要在运行时通过向同一个 <code>/proc/sys</code> 文件写入 1 来启用它。</p></div><div class="el-p"><p dir="auto"><code>sysrq</code> 操作非常有用，因此它们已提供给无法访问控制台的系统管理员。文件 <code>/proc/sysrq-trigger</code> 是一个只写入口点，你可以通过写入相关的命令字符来触发特定的 <code>sysrq</code> 操作；然后你可以从内核日志中收集任何输出数据。这个 <code>sysrq</code> 的入口点始终有效，即使 <code>sysrq</code> 在控制台上被禁用。</p></div><div class="el-p"><p dir="auto">如果你遇到“活动挂起”，即你的驱动程序卡在循环中但整个系统仍在运行，有几个值得了解的技术。通常，<code>SysRq p</code> 功能会直接指向有问题的例程。如果失败，你还可以使用内核分析功能。构建一个启用了分析功能的内核，并使用 <code>profile=2</code> 启动它。使用 <code>readprofile</code> 实用程序重置分析计数器，然后让你的驱动程序进入循环。稍后，再次使用 <code>readprofile</code> 查看内核在哪里花费时间。另一个更高级的替代方法是 <code>oprofile</code>，你也可以考虑使用它。文件 <code>Documentation/basic_profiling.txt</code> 告诉你开始使用分析器所需的一切。</p></div><div class="el-p"><p dir="auto">在追踪系统挂起时，一个值得使用的预防措施是以只读方式挂载所有磁盘（或卸载它们）。如果磁盘是只读的或卸载的，就没有损坏文件系统或使其处于不一致状态的风险。另一种可能性是使用通过 NFS（网络文件系统）挂载所有文件系统的计算机。内核中必须启用“NFS-Root”功能，并且在启动时必须传递特殊参数。在这种情况下，你将避免文件系统损坏，甚至无需使用 <code>SysRq</code>，因为文件系统一致性由 NFS 服务器管理，它不会被你的设备驱动程序关闭。</p></div><div class="mod-footer mod-ui"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="第4章-调试技术/4.5-调试系统故障.html#4.5 调试系统故障"><div class="tree-item-contents heading-link" heading-name="4.5 调试系统故障"><span class="tree-item-title">4.5 调试系统故障</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="第4章-调试技术/4.5-调试系统故障.html#`Oops`_消息"><div class="tree-item-contents heading-link" heading-name="`Oops` 消息"><span class="tree-item-title"><code>Oops</code> 消息</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="第4章-调试技术/4.5-调试系统故障.html#系统挂起"><div class="tree-item-contents heading-link" heading-name="系统挂起"><span class="tree-item-title">系统挂起</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>