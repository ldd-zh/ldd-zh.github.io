# 快速参考

本节总结了我们在本章中提到的内核函数、变量、宏和 `/proc` 文件。它旨在作为参考。每个项目在相关头文件（如果有）之后列出。从本章开始，几乎每章末尾都有一个类似的章节，总结了本章中引入的新符号。本节中的条目通常按照它们在章节中引入的顺序出现：

- `insmod`、`modprobe`、`rmmod`：用户空间实用程序，用于将模块加载到运行中的内核并移除它们。
- `#include <linux/init.h>`、`module_init(init_function)`、`module_exit(cleanup_function)`：宏，用于指定模块的初始化和清理函数。
- `__init`、`__initdata`、`__exit`、`__exitdata`：标记仅用于模块初始化或清理时间的函数（`__init` 和 `__exit`）和数据（`__initdata` 和 `__exitdata`）。标记为初始化的项在初始化完成后可能会被丢弃；退出项在未配置模块卸载到内核时可能会被丢弃。这些标记通过将相关对象放置在可执行文件中的特殊 ELF 部分中来工作。
- `#include <linux/sched.h>`：最重要的头文件之一。该文件包含驱动程序使用的许多内核 API 的定义，包括睡眠函数和众多变量声明。
- `struct task_struct *current`：当前进程。
- `current->pid`、`current->comm`：当前进程的进程 ID 和命令名称。
- `obj-m`：内核构建系统使用的 `makefile` 符号，用于确定应在当前目录中构建哪些模块。
- `/sys/module`、`/proc/modules`：`/sys/module` 是一个 `sysfs` 目录层次结构，包含有关当前加载模块的信息。`/proc/modules` 是该信息的较旧的单文件版本。条目包含模块名称、每个模块占用的内存量和使用计数。附加到每行的额外字符串指定当前对模块有效的标志。
- `vermagic.o`：来自内核源目录的对象文件，描述模块构建的环境。
- `#include <linux/module.h>`：必需的头文件。模块源必须包含它。
- `#include <linux/version.h>`：包含有关正在构建的内核版本信息的头文件。
- `LINUX_VERSION_CODE`：整数宏，用于 `#ifdef` 版本依赖。
- `EXPORT_SYMBOL(symbol)`、`EXPORT_SYMBOL_GPL(symbol)`：用于将符号导出到内核的宏。第二种形式导出时不使用版本信息，第三种形式将导出限制为 GPL 许可的模块。
- `MODULE_AUTHOR(author)`、`MODULE_DESCRIPTION(description)`、`MODULE_VERSION(version_string)`、`MODULE_DEVICE_TABLE(table_info)`、`MODULE_ALIAS(alternate_name)`：将模块的文档放置在目标文件中。
- `module_init(init_function)`、`module_exit(exit_function)`：声明模块初始化和清理函数的宏。
- `#include <linux/moduleparam.h>`、`module_param(variable, type, perm)`：创建模块参数的宏，用户可以在加载模块时（或内置代码的启动时）调整该参数。类型可以是 `bool`、`charp`、`int`、`invbool`、`long`、`short`、`ushort`、`uint`、`ulong` 或 `intarray` 之一。
- `#include <linux/kernel.h>`、`int printk(const char *fmt, ...)`：内核代码中 `printf` 的类似物。

---

### 总结

本章介绍了如何构建和运行 Linux 内核模块，涵盖了从简单的“hello world”模块到模块参数、错误处理和并发性等高级主题。通过理解这些基本概念，你可以开始编写更复杂的内核模块，并逐步掌握 Linux 设备驱动开发的精髓。在接下来的章节中，我们将深入探讨特定设备类别的驱动程序开发，并进一步扩展这些基础知识。


