<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using https://github.com/wa-lang/wabook -->
        <meta charset="UTF-8">
        <title>编译与加载 - linux设备驱动</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../static/wabook/css/variables.css">
        <link rel="stylesheet" href="../static/wabook/css/general.css">
        <link rel="stylesheet" href="../static/wabook/css/chrome.css">
        <link rel="stylesheet" href="../static/wabook/css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../static/wabook/FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../static/wabook/fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../static/wabook/highlight.css">
        <link rel="stylesheet" href="../static/wabook/tomorrow-night.css">
        <link rel="stylesheet" href="../static/wabook/ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('wabook-theme');
                var sidebar = localStorage.getItem('wabook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('wabook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('wabook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('wabook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('wabook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter">
  <li class="chapter-item expanded ">
    <a href="../index.html" >linux设备驱动</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../preface.html" >前言</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch1/chapter_1.html" ><strong aria-hidden="true">1.</strong> 设备驱动简介</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.1.html" ><strong aria-hidden="true">1.1.</strong> 设备驱动的角色</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.2.html" ><strong aria-hidden="true">1.2.</strong> 内核的划分</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.3.html" ><strong aria-hidden="true">1.3.</strong> 设备和模块的分类</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.4.html" ><strong aria-hidden="true">1.4.</strong> 安全问题</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.5.html" ><strong aria-hidden="true">1.5.</strong> 版本编号</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.6.html" ><strong aria-hidden="true">1.6.</strong> 许可条款</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.7.html" ><strong aria-hidden="true">1.7.</strong> 加入内核开发社区</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1/chapter_1.8.html" ><strong aria-hidden="true">1.8.</strong> 本书概述</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch2/chapter_2.html" ><strong aria-hidden="true">2.</strong> 构建和运行模块</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.1.html" ><strong aria-hidden="true">2.1.</strong> 配置测试系统</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.2.html" ><strong aria-hidden="true">2.2.</strong> Hello World模块</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.3.html" ><strong aria-hidden="true">2.3.</strong> 内核模块与应用程序的对比</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.4.html" class="active"><strong aria-hidden="true">2.4.</strong> 编译与加载</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.5.html" ><strong aria-hidden="true">2.5.</strong> 内核符号表</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.6.html" ><strong aria-hidden="true">2.6.</strong> 基础准备工作</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.7.html" ><strong aria-hidden="true">2.7.</strong> 初始化与关闭</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.8.html" ><strong aria-hidden="true">2.8.</strong> 模块参数</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.9.html" ><strong aria-hidden="true">2.9.</strong> 用户空间编程</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2/chapter_2.10.html" ><strong aria-hidden="true">2.10.</strong> 快速参考</a>
    </li>
  </ol>
</ol>

            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title"><a href="../index.html">linux设备驱动</a></h1>

                    <div class="right-buttons">
                        <a href="https://github.com/ldd-zh/ldd-zh.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ldd-zh/ldd-zh.github.io/edit/master/testdata/ch2/chapter_2.4.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <!-- Page table of contents -->
                    <div class="sidetoc"><nav class="pagetoc"></nav></div>

                    <main>
                        

                        <h1>编译与加载</h1>
<p>本章开头的“Hello World”示例简要演示了如何构建一个模块并将其加载到系统中。当然，整个过程远不止我们目前所见的那样。本节将更详细地介绍模块作者如何将源代码转化为内核中可执行的子系统。</p>
<h2>编译模块</h2>
<p>首先，我们需要了解模块是如何构建的。模块的构建过程与用户空间应用程序的构建过程有很大不同；内核是一个庞大的独立程序，对其各部分如何组合有明确和详细的要求。构建过程与以前版本的内核也有所不同；新的构建系统更易于使用，能产生更正确的结果，但与之前的方式有很大差异。内核的构建系统非常复杂，我们这里只讨论其中的一小部分。如果你想深入了解内核构建系统的全部内容，可以阅读内核源代码中的Documentation/kbuild目录下的文件，这些是必读材料。</p>
<p>在你开始构建内核模块之前，有一些先决条件需要满足。首先，你需要确保你拥有最新版本的编译器、模块工具和其他必要工具。内核文档目录中的Documentation/Changes文件会列出所需的工具版本，使用前应先查阅它。使用错误版本的工具构建内核（及其模块）可能会导致许多细微而难以解决的问题。请注意，有时过新的编译器版本可能会像过老的版本一样带来问题；内核源代码对编译器有很多假设，新的版本可能会在一段时间内造成不兼容。</p>
<p>如果你还没有准备好内核树，或者尚未配置并构建内核，那么现在就是时候做这些了。如果没有将内核树放到文件系统中，你无法为2.6内核构建可加载模块。虽然并非强制要求，但如果你正在构建的内核与你正在运行的内核相同，那会更加有帮助。</p>
<p>一旦你设置好环境，创建模块的Makefile非常简单。事实上，在本章开头展示的“Hello World”示例中，一行代码就足够了：</p>
<pre><code class="language-makefile">obj-m := hello.o
</code></pre>
<p>如果你熟悉make，但对2.6内核构建系统不太了解，你可能会想知道这个Makefile是如何工作的。毕竟，上述这一行并不是传统Makefile的样子。答案很简单，内核构建系统会处理其余部分。上述赋值语句（利用了GNU Make提供的扩展语法）表示从目标文件hello.o构建一个模块，生成的模块名为hello.ko。</p>
<p>如果你有一个名为module.ko的模块，它是由两个源文件（比如file1.c和file2.c）生成的，那么正确的写法应该是：</p>
<pre><code class="language-makefile">obj-m := module.o
module-objs := file1.o file2.o
</code></pre>
<p>要使像上面这样的Makefile生效，必须在更大的内核构建系统的上下文中调用它。如果你的内核源代码树位于~/kernel-2.6目录下，那么构建模块所需的make命令（在模块源代码和Makefile所在的目录中输入）是：</p>
<pre><code class="language-makefile">make -C ~/kernel-2.6 M=`pwd` modules
</code></pre>
<p>该命令首先将工作目录更改为通过-C选项指定的目录（即内核源代码目录）。在该目录下，找到内核的顶层Makefile。M=选项会使得该Makefile在构建模块目标之前，切换回你的模块源代码目录。这个目标会引用obj-m变量中列出的模块，我们在示例中将其设置为module.o。</p>
<p>长时间输入之前的make命令可能会让人感到麻烦，因此内核开发者开发了一种Makefile写法，使得在内核树外构建模块变得更轻松。诀窍是按如下方式编写Makefile：</p>
<pre><code class="language-makefile"># 如果KERNELRELEASE已定义，表示我们已经从内核构建系统中调用，可以使用其语言。
ifneq ($(KERNELRELEASE),)
	obj-m := hello.o

# 否则是直接从命令行调用，需调用内核构建系统。
else
	KERNELDIR ?= /lib/modules/$(shell uname -r)/build
	PWD := $(shell pwd)

default:
	$(MAKE) -C $(KERNELDIR) M=$(PWD) modules

endif
</code></pre>
<p>再次看到的是GNU Make扩展语法的应用。这个Makefile会被读取两次。在从命令行调用Makefile时，发现KERNELRELEASE变量没有被设置，它通过利用已安装模块目录中的符号链接build指向内核构建树来找到内核源代码目录。如果你并未运行正在构建的内核，可以在命令行中提供KERNELDIR=选项，设置KERNELDIR环境变量，或者直接修改Makefile中设置KERNELDIR的那一行。一旦找到内核源代码树，Makefile会调用default:目标，后者会运行第二次make命令（在Makefile中通过$(MAKE)来调用），按照之前的描述调用内核构建系统。</p>
<p>在第二次读取时，Makefile设置了obj-m变量，内核的Makefile系统将实际构建模块。</p>
<p>这种构建模块的机制可能看起来有些笨重和晦涩，但一旦你熟悉了它，你可能会更欣赏内核构建系统所提供的强大功能。需要注意的是，上述并不是一个完整的Makefile，实际的Makefile还包含用于清理无用文件、安装模块等的常见目标。你可以参考示例源代码目录中的Makefile，了解完整的示例。</p>
<h2>加载与卸载模块</h2>
<p>模块构建完成后，下一步就是将其加载到内核中。正如我们之前提到的，insmod可以完成这项工作。该程序将模块的代码和数据加载到内核中，内核则执行类似于ld的功能，负责将模块中未解析的符号与内核的符号表链接。然而，与链接器不同的是，内核不会修改模块的磁盘文件，而是修改内存中的副本。insmod接受多个命令行选项（具体可参见手册页），并且可以在将模块链接到当前内核之前，为模块中的参数赋值。因此，如果模块设计得当，它可以在加载时进行配置；与编译时配置相比，加载时配置为用户提供了更大的灵活性，尽管有时仍会使用编译时配置。关于加载时配置的内容，可以参考本章后面的“模块参数”部分。</p>
<p>有兴趣的读者可以查看内核是如何支持insmod的：它依赖于在kernel/module.c中定义的系统调用。sys_init_module函数为模块分配内核内存（此内存是通过vmalloc分配的；关于vmalloc的更多内容，请参见第8章“vmalloc及其相关函数”部分），然后将模块的文本复制到该内存区域，利用内核符号表解析模块中的内核引用，并调用模块的初始化函数来启动模块。</p>
<p>如果你深入查看内核源代码，会发现所有系统调用的名称前都加有sys_前缀。这对于所有系统调用函数都是如此，而其他函数则不加此前缀。在源代码中使用grep查找系统调用时，记得留意这一点。</p>
<p>此外，modprobe工具也值得一提。与insmod类似，modprobe用于将模块加载到内核中。它的不同之处在于，modprobe会检查待加载的模块，看看是否引用了当前内核中未定义的符号。如果发现此类未定义的引用，modprobe会在当前模块搜索路径中查找定义了相关符号的其他模块。当modprobe找到这些模块（这些模块是被加载模块所依赖的）时，它会将它们一并加载到内核中。如果此时你使用insmod命令，系统会报错并在日志中留下“未解析符号”的消息。</p>
<p>如前所述，可以使用rmmod工具从内核中移除模块。需要注意的是，如果内核认为模块仍在使用中（例如，某个程序仍然打开了由该模块导出的设备文件），或者内核被配置为禁止模块卸载，则模块移除会失败。内核还可以被配置为允许“强制”卸载模块，即使模块看起来仍在使用中。然而，如果你已经考虑使用这个选项，问题可能已经严重到需要重启系统的程度，重启可能是更好的解决方案。</p>
<p>lsmod程序可以列出当前加载到内核中的模块。它还会提供一些其他信息，例如哪些模块正在使用某个特定模块。lsmod通过读取/proc/modules虚拟文件来工作。有关当前加载的模块的信息，也可以在sysfs虚拟文件系统中的/sys/module目录下找到。</p>
<h2>版本依赖性</h2>
<p>请记住，模块的代码必须针对每个与之链接的内核版本重新编译——至少在没有使用版本控制（modversions）的情况下，后者更多是面向发行版开发者，而非模块开发者。模块与特定内核版本中定义的数据结构和函数原型紧密相关；模块所见的接口可能会在不同的内核版本之间发生显著变化，尤其是在开发版本的内核中，变化更为频繁。</p>
<p>内核并不会假设某个模块是针对正确的内核版本构建的。构建过程中的一个步骤是将模块与当前内核树中的一个文件（名为vermagic.o）链接；这个目标文件包含了有关模块构建时所用内核的许多信息，包括目标内核版本、编译器版本以及多个重要配置变量的设置。当尝试加载模块时，内核会检查这些信息是否与正在运行的内核兼容。如果不匹配，模块将无法加载，通常会出现类似如下的错误信息：</p>
<pre><code class="language-sh"># insmod hello.ko
Error inserting './hello.ko': -1 Invalid module format
</code></pre>
<p>查看系统日志文件（如/var/log/messages或你系统配置的日志文件）会揭示导致模块加载失败的具体问题。</p>
<p>如果你需要为特定的内核版本编译模块，则需要使用该版本的构建系统和源代码树。在前面示例的makefile中，简单修改KERNELDIR变量即可实现这一目的。</p>
<p>内核接口通常会在版本发布之间发生变化。如果你正在编写一个需要支持多个内核版本（尤其是跨主版本发布）的模块，你很可能需要使用宏和#ifdef结构来确保你的代码能够正确编译。由于本书版本只涉及一个主要版本的内核，所以在我们的示例代码中很少见到版本测试。然而，在某些情况下，确实需要进行版本检查。在这种情况下，你可以利用linux/version.h中定义的内容。这个头文件定义了以下宏：</p>
<ul>
<li>
<p>UTS_RELEASE</p>
<p>该宏展开为一个描述当前内核树版本的字符串。例如，“2.6.10”。</p>
</li>
<li>
<p>LINUX_VERSION_CODE</p>
<p>该宏展开为内核版本的二进制表示，每个版本号的部分占一个字节。例如，2.6.10的版本代码为132618（即0x02060a）。有了这个信息，你几乎可以轻松地确定正在使用的内核版本。</p>
</li>
<li>
<p>KERNEL_VERSION(major, minor, release)</p>
<p>该宏用于从版本号的各个部分构建一个整数版本代码。例如，KERNEL_VERSION(2,6,10)会展开为132618。这个宏在你需要比较当前版本和已知版本时非常有用。</p>
</li>
</ul>
<p>大多数基于内核版本的依赖可以通过预处理器条件，利用KERNEL_VERSION和LINUX_VERSION_CODE来解决。然而，版本依赖性不应使驱动程序代码充斥着复杂的#ifdef条件；解决不兼容问题的最佳方式是将这些条件限制在特定的头文件中。作为一般规则，显式依赖于版本（或平台）的代码应隐藏在低级宏或函数后面。高层代码可以直接调用这些函数，而无需关心低层的细节。以这种方式编写的代码通常更容易阅读且更健壮。</p>
<h2>平台依赖性</h2>
<p>每个计算机平台都有其独特性，内核设计师可以充分利用这些特性，以实现目标目标文件的最佳性能。</p>
<p>与应用程序开发者必须将代码与预编译的库链接，并遵循参数传递约定不同，内核开发者可以将某些处理器寄存器专门分配给特定的任务，而他们确实这么做了。此外，内核代码可以针对特定处理器进行优化，以充分发挥目标平台的性能：与通常以二进制格式分发的应用程序不同，定制编译的内核可以针对特定的计算机配置进行优化。</p>
<p>例如，IA32（x86）架构已经被细分为几个不同的处理器类型。尽管其指令集按现代标准来看相当有限，但旧款的80386处理器仍然受到支持（至少目前是这样）。该架构中的更现代处理器引入了许多新特性，包括更快的进入内核指令、处理器间锁、数据复制等。新的处理器还可以在正确模式下使用36位（或更大）物理地址，从而能够寻址超过4GB的物理内存。其他处理器家族也有类似的改进。内核可以根据不同的配置选项进行构建，以利用这些附加功能。</p>
<p>显然，如果模块要与给定的内核一起工作，它必须与该内核使用相同的处理器配置进行构建。这里，vermagic.o目标文件再次发挥作用。当模块被加载时，内核会检查模块的处理器特定配置选项，确保它们与正在运行的内核匹配。如果模块是使用不同选项编译的，它将不会被加载。</p>
<p>如果你计划编写一个供一般分发使用的驱动程序，你可能会想知道如何支持所有这些不同的变种。最好的答案，当然，是将你的驱动程序以GPL兼容的许可发布，并将其贡献给主线内核。如果做不到这一点，分发驱动程序的源代码，并提供一套脚本来在用户的系统上编译它，可能是最佳的解决方案。一些厂商已经发布了工具来简化这项任务。如果你必须以二进制形式分发驱动程序，你需要查看目标发行版所提供的不同内核，并为每个内核提供一个版本的模块。请确保考虑到自发行版发布以来，可能已经发布的内核补丁和修复。然后，你还需要考虑许可证问题，正如我们在第1章“许可证条款”部分讨论的那样。一般来说，以源代码形式分发是更易于适应世界的方式。</p>


                        

                        

                        
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../ch2/chapter_2.3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                        
                            <!-- ../ch2/chapter_2.5.html -->
                            <a rel="next" href="../ch2/chapter_2.5.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../ch2/chapter_2.3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                
                    <a rel="next" href="../ch2/chapter_2.5.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../static/wabook/mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../static/wabook/clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../static/wabook/highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../static/wabook/book.js" type="text/javascript" charset="utf-8"></script>
        
        <script type="text/javascript" charset="utf-8">
            var pagePath = "ch2/chapter_2.4.md"
        </script>

        <!-- Custom JS scripts -->
        

    </body>
</html>
